# Deployment workflow on firebase emulators locally
if [ "$CI" = "true" ]; then
    echo "Skipping pre-push hook in CI environment"
    exit 0
fi

PORT=5002

# Stop any existing emulator on the hosting port to avoid duplicate instances
EXISTING_PID=$(lsof -t -i:$PORT 2>/dev/null | head -n 1)
if [ -n "$EXISTING_PID" ]; then
    kill "$EXISTING_PID"
    echo "Stopped existing process $EXISTING_PID on port $PORT"
    sleep 1
fi

npm run emu &

HOSTING_URL="http://localhost:$PORT"

export BASE_URL=$HOSTING_URL
npm run test

# Kill the process running on the port
if [ -n "$PORT" ]; then
    PID=$(lsof -t -i:$PORT 2>/dev/null | head -n 1)
    if [ -n "$PID" ]; then
        kill $PID
        echo "Killed process $PID was running on port $PORT"
    fi
fi
